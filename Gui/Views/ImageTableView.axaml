<UserControl
	xmlns="https://github.com/avaloniaui"
	xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
	xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
	xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
	xmlns:vm="using:Gui.ViewModels"
	xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
	xmlns:pgc="clr-namespace:Avalonia.PropertyGrid.Controls;assembly=Avalonia.PropertyGrid"
	xmlns:amxc="using:Avalonia.Markup.Xaml.Converters"
	xmlns:gmc="using:Gui.Models.Converters"
	xmlns:paz="using:Avalonia.Controls.PanAndZoom"
	xmlns:vi="using:Gui.Views"
	mc:Ignorable="d"
	d:DesignWidth="1200"
	d:DesignHeight="900"
	x:Class="Gui.Views.ImageTableView"
	x:DataType="vm:ImageTableViewModel">

	<UserControl.Resources>
		<amxc:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
		<gmc:NegativeValueConverter x:Key="NegativeValueConverter"/>
	</UserControl.Resources>

	<DockPanel>
		<StackPanel DockPanel.Dock="Top" Orientation="Horizontal">
			<Button Command="{Binding ImportImagesCommand}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Import a directory of .pngs">
				<DockPanel>
					<materialIcons:MaterialIcon Kind="FolderUpload" Width="24" Height="24" Margin="2" />
					<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Import</TextBlock>
				</DockPanel>
			</Button>
			<Button Command="{Binding ExportImagesCommand}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Export all images as .pngs to a directory">
				<DockPanel>
					<materialIcons:MaterialIcon Kind="FolderDownload" Width="24" Height="24" Margin="2" />
					<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Export</TextBlock>
				</DockPanel>
			</Button>
			<Button HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Background colour">
				<DockPanel>
					<materialIcons:MaterialIcon Kind="Palette" Width="24" Height="24" Margin="2" />
					<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Background colour</TextBlock>
				</DockPanel>
				<Button.Flyout >
					<Flyout>
						<ColorView Name="ImageBackgroundColorView" Palette="" Color="SteelBlue" IsColorModelVisible="False" IsColorSpectrumVisible="False" IsColorComponentsVisible="False" />
					</Flyout>
				</Button.Flyout>
			</Button>
			<ComboBox ItemsSource="{Binding ColourSwatchesArr}" SelectedItem="{Binding SelectedPrimarySwatch}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Primary remap swatch" />
			<ComboBox ItemsSource="{Binding ColourSwatchesArr}" SelectedItem="{Binding SelectedSecondarySwatch}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Secondary remap swatch" />
			<Button Command="{Binding CropAllImagesCommand}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Crops all images and adjusts offsets">
				<DockPanel>
					<materialIcons:MaterialIcon Kind="Crop" Width="24" Height="24" Margin="2" />
					<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Crop all</TextBlock>
				</DockPanel>
			</Button>
			<Button Command="{Binding ZeroOffsetAllImagesCommand}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Sets all image offsets to 0">
				<DockPanel>
					<materialIcons:MaterialIcon Kind="PanTopLeft" Width="24" Height="24" Margin="2" />
					<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Zero all offsets</TextBlock>
				</DockPanel>
			</Button>
			<Button Command="{Binding CenterOffsetAllImagesCommand}" HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Sets all image offsets to the centre of the image">
				<DockPanel>
					<materialIcons:MaterialIcon Kind="Pan" Width="24" Height="24" Margin="2" />
					<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Center all offsets</TextBlock>
				</DockPanel>
			</Button>
		</StackPanel>
		<Grid ColumnDefinitions="*, Auto, 384">
			<ScrollViewer Margin="4">
				<DockPanel>
					<Panel Width="16" DockPanel.Dock="Right"></Panel>
					<ItemsControl ItemsSource="{Binding GroupedImageViewModels}" Margin="4">
						<ItemsControl.ItemTemplate>
							<DataTemplate>
								<Expander Header="{Binding GroupName}" IsExpanded="True" Margin="4" Padding="0" HorizontalAlignment="Stretch">
									<ListBox ItemsSource="{Binding Images}" SelectionMode="Multiple" Background="{Binding #ImageBackgroundColorView.Color, ConverterParameter={x:Static Brushes.Transparent}, Converter={StaticResource ColorToBrushConverter}}">
										<ListBox.ItemsPanel>
											<ItemsPanelTemplate>
												<WrapPanel />
											</ItemsPanelTemplate>
										</ListBox.ItemsPanel>
										<ListBox.ItemTemplate>
											<DataTemplate>
												<Image Source="{Binding DisplayedImage}" Stretch="None" Margin="0">
													<Image.ContextMenu>
														<ContextMenu>
															<MenuItem Header="Replace image" Command="{Binding $parent[ListBox].((vm:ImageTableViewModel)DataContext).ReplaceImageCommand}"/>
															<MenuItem Header="Crop image" Command="{Binding $parent[ListBox].((vm:ImageTableViewModel)DataContext).CropImageCommand}"/>
														</ContextMenu>
													</Image.ContextMenu>
												</Image>
											</DataTemplate>
										</ListBox.ItemTemplate>
									</ListBox>
								</Expander>
							</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>
				</DockPanel>
			</ScrollViewer>
			<GridSplitter Grid.Column="1" />
			<DockPanel Grid.Column="2">
				<StackPanel Margin="2" Orientation="Vertical" MaxHeight="512" DockPanel.Dock="Top">
					<TextBlock Margin="0, 16, 0, 0" HorizontalAlignment="Center" Text="{Binding AnimationSpeed, StringFormat='Animation FPS: {0}'}"></TextBlock>
					<Slider Minimum="1" Maximum="80" Value="{Binding AnimationSpeed}" />
					<StackPanel Orientation="Horizontal">
						<Button HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Select preview background colour">
							<DockPanel>
								<materialIcons:MaterialIcon Kind="Palette" Width="24" Height="24" Margin="2" />
								<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Background</TextBlock>
							</DockPanel>
							<Button.Flyout >
								<Flyout>
									<ColorView Name="ImageColorViewPreviewBackground" Palette="" Color="SteelBlue" IsColorModelVisible="False" IsColorSpectrumVisible="False" IsColorComponentsVisible="False" />
								</Flyout>
							</Button.Flyout>
						</Button>
						<Button HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Select border preview colour">
							<DockPanel>
								<materialIcons:MaterialIcon Kind="Palette" Width="24" Height="24" Margin="2" />
								<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Border</TextBlock>
							</DockPanel>
							<Button.Flyout >
								<Flyout>
									<ColorView Name="ImageColorViewBorder" Palette="" Color="Gold" IsColorModelVisible="False" IsColorSpectrumVisible="False" IsColorComponentsVisible="False" />
								</Flyout>
							</Button.Flyout>
						</Button>
						<Button HorizontalAlignment="Stretch" Margin="2" Padding="2" ToolTip.Tip="Select origin point colour">
							<DockPanel>
								<materialIcons:MaterialIcon Kind="Palette" Width="24" Height="24" Margin="2" />
								<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Margin="4">Origin</TextBlock>
							</DockPanel>
							<Button.Flyout >
								<Flyout>
									<ColorView Name="ImageColorViewOriginPoint" Palette="" Color="Red" IsColorModelVisible="False" IsColorSpectrumVisible="False" IsColorComponentsVisible="False" />
								</Flyout>
							</Button.Flyout>
						</Button>
					</StackPanel>
					<paz:ZoomBorder Name="ZoomBorder" MinWidth="256" MinHeight="256" Stretch="None" ZoomSpeed="2.0" MinZoomX="0.5" MaxZoomX="64" MinZoomY="0.5" MaxZoomY="64" ClipToBounds="True" Focusable="True" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" PanButton="Left" Background="{Binding #ImageColorViewPreviewBackground.Color, ConverterParameter={x:Static Brushes.Transparent}, Converter={StaticResource ColorToBrushConverter}}" >
						<Canvas HorizontalAlignment="Center" VerticalAlignment="Center" Background="Gray">
							<!--Bounding box-->
							<Rectangle Canvas.Left="{Binding SelectedImage.SelectedBitmapPreviewBorder.X}" Canvas.Top="{Binding SelectedImage.SelectedBitmapPreviewBorder.Y}"  StrokeThickness="1.0" Width="{Binding SelectedImage.SelectedBitmapPreviewBorder.Width}" Height="{Binding SelectedImage.SelectedBitmapPreviewBorder.Height}" Opacity="1.0" Fill="{Binding #ImageColorViewPreviewBackground.Color, ConverterParameter={x:Static Brushes.Transparent}, Converter={StaticResource ColorToBrushConverter}}" Stroke="{Binding #ImageColorViewBorder.Color, ConverterParameter={x:Static Brushes.Transparent}, Converter={StaticResource ColorToBrushConverter}}" />
							<!--Image-->
							<Image Canvas.Left="{Binding SelectedImage.XOffset}" Canvas.Top="{Binding SelectedImage.YOffset}" Source="{Binding SelectedImage.DisplayedImage}" RenderOptions.BitmapInterpolationMode="None" Stretch="None"/>
							<!--Origin point-->
							<Rectangle Canvas.Left="0" Canvas.Top="0" Width="1" Height="1" Opacity="1.0" Fill="{Binding #ImageColorViewOriginPoint.Color, ConverterParameter={x:Static Brushes.Transparent}, Converter={StaticResource ColorToBrushConverter}}" />
						</Canvas>
					</paz:ZoomBorder>
					<TextBlock HorizontalAlignment="Center" Text="{Binding #ZoomBorder.ZoomX, StringFormat='Zoom: {0:F2}x | \'R\' to reset'}"></TextBlock>
				</StackPanel>
				<ContentControl Content="{Binding SelectedImage}" />
			</DockPanel>
		</Grid>
	</DockPanel>
</UserControl>
